---
title: "alphaTab.js: programmer's guitar Node.js package"
description: "从零开始在 Astro 博客中引入 alphaTab.js，与 React 岛组件结合，驱动吉他谱渲染与暗色模式控制。"
pubDatetime: 2025-09-25T00:00:00+08:00
draft: false
tags:
  - astro
  - react
  - alphaTab
  - music
slug: alphatab-js-programers-guitar-nodejs-package
ogImage: ../../../assets/images/2025/alphatab-js-programers-guitar-nodejs-package/og-default.svg
---

import AlphaTabApp from "@/components/react/AlphaTabApp";

> Integrating your React application into an Astro project and managing global state like dark mode is a great way to leverage Astro's performance benefits. Here’s a step-by-step guide on how you would do it.

## 🎸 Live Demo: alphaTab React Player

<AlphaTabApp client:only="react" />

上面的 React 岛组件演示了完整的暗色/亮色主题切换、乐谱文件载入与 alphaTab 渲染流程。下面按照步骤拆解整个实现。

## 1. Setting Up Your Astro Project with React

首先需要一个 Astro 项目以及 React 集成。

### 1.1 Create an Astro project (if you don't have one)

```bash
# npm
npm create astro@latest

# yarn
yarn create astro

# pnpm
pnpm create astro@latest
```

### 1.2 Add the React integration

如果在初始化时错过了 React 集成，可以在项目目录下补跑一次：

```bash
npx astro add react
```

这一步会安装必要依赖并在 `astro.config.ts` 中写入 React 集成配置。

## 2. Migrating Your React Components

将现有的 React 代码移动到 `src/components/` 目录。常见的目录结构如下：

```
/
├── public/
├── src/
│   ├── components/
│   │   ├── App.tsx
│   │   └── AlphaTabPlayer.tsx
│   ├── layouts/
│   └── pages/
└── package.json
```

## 3. Handling Global Scripts and Styles

原来写在 `index.html` 的全局脚本（例如 alphaTab.js 与全局 CSS）适合搬到 Astro 布局中，例如 `src/layouts/Layout.astro`：

```astro
---
interface Props {
  title: string;
}

const { title } = Astro.props;
---

<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>{title}</title>

    <!-- External AlphaTab Script -->
    <script
      src="https://cdn.jsdelivr.net/npm/@coderline/alphatab@latest/dist/alphaTab.js"
    ></script>

    <!-- Import Tailwind or add via CDN -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- Global Styles -->
    <style is:global>
      :root {
        --at-bg-primary: #ffffff;
        --at-bg-secondary: #f7f7ff7;
        /* ... all your other light mode variables */
      }
      html.dark {
        --at-bg-primary: #111827;
        --at-bg-secondary: #1f2937;
        /* ... all your other dark mode variables */
      }
      body {
        background-color: var(--at-bg-primary);
        color: var(--at-text-primary);
        transition:
          background-color 0.3s,
          color 0.3s;
      }
      /* AlphaTab Cursors & Highlights */
      .at-cursor-bar {
        background: rgba(255, 242, 0, 0.25) !important;
      }
      html.dark .at-cursor-bar {
        background: rgba(96, 165, 250, 0.25) !important;
      }
      /* ... all other global cursor/highlight styles */
    </style>
  </head>
  <body>
    <slot />
  </body>
</html>
```

## 4. Managing Global Dark Mode State

最佳实践是在 Astro 页面或者布局中用一段脚本管理全局的暗色模式状态，然后把这个状态下发给 React 岛组件。

思路如下：

- 布局脚本先检查 `localStorage` 中是否已有主题偏好；
- 若没有，则根据系统深浅色偏好选择默认主题；
- 挂载 `window.toggleTheme` 供 React 组件调用；
- React 岛组件读取 `<html>` 元素上的类名或属性即可知道当前主题。

`src/pages/index.astro` 可以这样写：

```astro
---
import Layout from "../layouts/Layout.astro";
import AlphaTabApp from "../components/App.tsx";
---

<Layout title="AlphaTab React Player">
  <main class="min-h-screen p-4">
    <!-- Render the React App as a client-side island -->
    <AlphaTabApp client:load />
  </main>
</Layout>

<script>
  const theme = (() => {
    if (typeof localStorage !== "undefined" && localStorage.getItem("theme")) {
      return localStorage.getItem("theme");
    }
    if (window.matchMedia("(prefers-color-scheme: dark)").matches) {
      return "dark";
    }
    return "light";
  })();

  if (theme === "dark") {
    document.documentElement.classList.add("dark");
  } else {
    document.documentElement.classList.remove("dark");
  }

  // Function to be called from React
  window.toggleTheme = () => {
    const isDark = document.documentElement.classList.toggle("dark");
    localStorage.setItem("theme", isDark ? "dark" : "light");
  };
</script>
```

## 5. Modifying the React App

最后，调整 React 组件，使其读取来自 DOM 的初始主题并通过全局函数完成切换：

```tsx
import React, { useState, useEffect } from "react";
import AlphaTabPlayer from "./AlphaTabPlayer";
import { Sun, Moon } from "lucide-react";

// Make the global function available in TypeScript
declare global {
  interface Window {
    toggleTheme: () => void;
  }
}

const App: React.FC = () => {
  // Read initial state from the DOM, then sync with state
  const [isDarkMode, setIsDarkMode] = useState(() =>
    document.documentElement.classList.contains("dark")
  );
  const [source, setSource] = useState<string | File>(
    "https://www.alphatab.net/files/canon.gp"
  );
  const [key, setKey] = useState(Date.now());

  // Listen for changes on the <html> element
  useEffect(() => {
    const observer = new MutationObserver(() => {
      setIsDarkMode(document.documentElement.classList.contains("dark"));
    });
    observer.observe(document.documentElement, {
      attributes: true,
      attributeFilter: ["class"],
    });
    return () => observer.disconnect();
  }, []);

  // Suppress ResizeObserver error
  useEffect(() => {
    const originalError = window.console.error;
    const resizeObserverLoopErr =
      "ResizeObserver loop completed with undelivered notifications";
    window.console.error = (...args) => {
      if (
        args.length > 0 &&
        typeof args[0] === "string" &&
        args[0].startsWith(resizeObserverLoopErr)
      )
        return;
      originalError.apply(console, args);
    };
    return () => {
      window.console.error = originalError;
    };
  }, []);

  const handleFileChange = (event: React.ChangeEvent<HTMLInputElement>) => {
    if (event.target.files && event.target.files[0]) {
      setSource(event.target.files[0]);
      setKey(Date.now());
    }
  };

  return (
    <div className="bg-[--at-bg-primary] font-sans text-[--at-text-primary] transition-colors duration-300">
      <header className="mb-4 flex items-center justify-between">
        <h1 className="text-2xl font-bold">AlphaTab React Player</h1>
        <div className="flex items-center gap-4">
          <div className="flex items-center">
            <label
              htmlFor="file-upload"
              className="cursor-pointer rounded-md bg-[--at-control-bg] px-4 py-2 text-[--at-control-text] transition-colors hover:bg-[--at-control-active-bg]"
            >
              Load GP File
            </label>
            <input
              id="file-upload"
              type="file"
              className="hidden"
              onChange={handleFileChange}
              accept=".gp,.gpx,.gp3,.gp4,.gp5,.gp6,.gp7"
            />
          </div>
          {/* Call the global function defined in the Astro page */}
          <button
            onClick={() => window.toggleTheme()}
            className="rounded-full bg-[--at-bg-secondary] p-2 transition-colors hover:bg-[--at-bg-tertiary]"
          >
            {isDarkMode ? (
              <Sun className="text-yellow-400" />
            ) : (
              <Moon className="text-gray-700" />
            )}
          </button>
        </div>
      </header>
      <div className="flex justify-center">
        <AlphaTabPlayer key={key} source={source} isDarkMode={isDarkMode} />
      </div>
    </div>
  );
};

export default App;
```

这样就完成了 Astro + React + alphaTab.js 的整合。你可以继续扩展播放器功能，例如节拍器、速度控制、播放列表等，或者把它直接嵌入到更多的教程型文章中。
